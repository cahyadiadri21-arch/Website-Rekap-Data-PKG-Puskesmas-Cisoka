<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form Input Puskesmas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h3 class="text-center mb-3">üìã Form Input Data Puskesmas</h3>

    <form id="formInput" class="card p-3 shadow-sm">
      <div class="mb-3">
        <label class="form-label">Nama Siswa</label>
        <input type="text" name="nama" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">NIK</label>
        <input type="text" name="nik" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Nama Sekolah</label>
        <input type="text" name="sekolah" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Kelas</label>
        <select name="kelas" class="form-select" required>
          <option value="">-- Pilih Kelas --</option>
          <option>1 SD</option>
          <option>2 SD</option>
          <option>3 SD</option>
          <option>1 SMP</option>
          <option>2 SMP</option>
          <option>3 SMP</option>
          <option>1 SMA</option>
          <option>2 SMA</option>
          <option>3 SMA</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Tanggal Pendaftaran</label>
        <input type="date" name="tanggal" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Petugas Entri</label>
        <input type="text" name="petugas" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">UNIT</label>
        <select name="unit" class="form-select" required>
          <option value="">-- Pilih UNIT --</option>
          <option>GIGI</option>
          <option>BP UMUM</option>
          <option>IMUNISASI</option>
          <option>GIZI PROMKES</option>
          <option>KIA</option>
          <option>LAB</option>
          <option>LANSIA KESLING</option>
          <option>UGD RANAP</option>
          <option>MANAGEMEN</option>
          <option>PONED</option>
          <option>TP PARU JIWA</option>
        </select>
      </div>
      <button type="submit" class="btn btn-success w-100">Kirim Data</button>
    </form>

    <div class="text-center mt-3">
      <button id="lihatData" class="btn btn-primary">üìä Lihat Data Unit</button>
    </div>

    <div id="dataContainer" class="mt-4"></div>
  </div>

  <script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbzvtXh8i9X-C3o5Kz-OQIWW3n4iTAG_uO_vEZGZAaDmOY5uyFFPuFrmdmUFVGqF0JPdaQ/exec";
  const form = document.getElementById("formInput");
  const dataContainer = document.getElementById("dataContainer");
  const btnLihatData = document.getElementById("lihatData");

  // === Kirim Data ke Sheet ===
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const jsonData = Object.fromEntries(formData.entries());
    jsonData.timestamp = new Date().toISOString();

    try {
      const response = await fetch(scriptURL, {
        method: "POST",
        mode: "cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(jsonData),
      });
      const result = await response.json();
      if (result.result === "success") {
        alert("‚úÖ Data berhasil dikirim ke UNIT: " + jsonData.unit);
        form.reset();
      } else {
        alert("‚ùå Gagal: " + (result.message || "Terjadi kesalahan"));
      }
    } catch (err) {
      alert("‚ö†Ô∏è Gagal mengirim data: " + err.message);
    }
  });

  // === Lihat Data dari Sheet ===
  btnLihatData.addEventListener("click", async () => {
    const selectedUnit = form.unit.value;
    if (!selectedUnit) {
      alert("‚ö†Ô∏è Pilih dulu UNIT sebelum melihat data!");
      return;
    }

    try {
      const res = await fetch(`${scriptURL}?action=read&unit=${encodeURIComponent(selectedUnit)}`);
      const data = await res.json();

      if (data.result !== "success") {
        alert("‚ùå Gagal memuat data: " + (data.message || "Error"));
        return;
      }

      let html = `
        <h5 class="mt-4">üìä Data Unit: ${selectedUnit}</h5>
        <table class="table table-bordered mt-3">
          <thead class="table-success">
            <tr>
              <th>No</th>
              <th>Nama</th>
              <th>NIK</th>
              <th>Sekolah</th>
              <th>Kelas</th>
              <th>Tanggal</th>
              <th>Petugas</th>
              <th>Unit</th>
              <th>Waktu Input</th>
            </tr>
          </thead>
          <tbody>
      `;

      data.data.slice(1).forEach((row, i) => {
        html += `
          <tr>
            <td>${i + 1}</td>
            <td>${row[0] || ""}</td>
            <td>${row[1] || ""}</td>
            <td>${row[2] || ""}</td>
            <td>${row[3] || ""}</td>
            <td>${row[4] || ""}</td>
            <td>${row[5] || ""}</td>
            <td>${row[6] || ""}</td>
            <td>${row[7] ? new Date(row[7]).toLocaleString() : ""}</td>
          </tr>`;
      });

      html += "</tbody></table>";
      dataContainer.innerHTML = html;
    } catch (err) {
      alert("‚ö†Ô∏è Gagal memuat data: " + err.message);
    }
  });
  </script>
</body>
</html>
